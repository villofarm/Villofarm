{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Registration â€“ {{ school.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    .registration-card {
      max-width: 850px;
      margin: 40px auto;
      border-radius: 10px;
    }
    label {
      font-weight: 500;
    }
    .is-invalid {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25);
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="text-center mb-4">
      {% if school.school_logo %}
        <img src="{{ school.school_logo.url }}" alt="{{ school.name }}" style="height:80px;">
      {% endif %}
      <h3>{{ school.name }}</h3>
      <p class="text-muted">School Code: {{ school.school_code }}</p>
    </div>

    <div class="card registration-card shadow-sm p-4">
      <h4 class="text-center mb-4">Student Registration Form</h4>

      <form id="registrationForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row g-3">
          <div class="col-md-4">
            <label for="{{ form.first_name.id_for_label }}">First Name</label>
            {{ form.first_name }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.surname.id_for_label }}">Surname</label>
            {{ form.surname }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.gender.id_for_label }}">Gender</label>
            {{ form.gender }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.dob.id_for_label }}">Date of Birth</label>
            {{ form.dob }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.contact_no.id_for_label }}">Contact No</label>
            {{ form.contact_no }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.email.id_for_label }}">Email</label>
            {{ form.email }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.session.id_for_label }}">Session</label>
            {{ form.session }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.student_class.id_for_label }}">Class</label>
            {{ form.student_class }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.religion.id_for_label }}">Religion</label>
            {{ form.religion }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.nationality.id_for_label }}">Nationality</label>
            {{ form.nationality }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.category.id_for_label }}">Category</label>
            {{ form.category }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.aadhar_no.id_for_label }}">Aadhar No</label>
            {{ form.aadhar_no }}
          </div>

          <div class="col-md-12">
            <label for="{{ form.address.id_for_label }}">Address</label>
            {{ form.address }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.state.id_for_label }}">State</label>
            {{ form.state }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.pincode.id_for_label }}">Pincode</label>
            {{ form.pincode }}
          </div>

          <div class="col-md-4">
            <label for="{{ form.profilepic.id_for_label }}">Student Photo</label>
            {{ form.profilepic }}
          </div>

          <!-- New Fields: Previous School Name and Address -->
          <div class="col-md-6">
            <label for="previous_school_name">Last School Name</label>
            <input type="text" class="form-control" id="previous_school_name"
                   name="previous_school_name" placeholder="Enter last school name">
          </div>
          <div class="col-md-6">
            <label for="previous_school_address">Last School Address</label>
            <textarea id="previous_school_address" name="previous_school_address"
                      class="form-control w-100" placeholder="Enter last school address"></textarea>
          </div>

          <!-- New Field: Marksheet Upload -->
          <div class="col-md-12 mt-3">
            <input type="file" class="form-control d-none" id="marksheet" name="marksheet"
                   accept="application/pdf,image/*">
            <label for="marksheet" class="btn btn-sm btn-outline-primary w-100">
              Upload Marksheet
            </label>
          </div>
        </div>

        <div class="mt-4 text-center">
          <button type="submit" class="btn btn-primary w-50 py-2">Submit Registration</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.getElementById("registrationForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      // Validate Aadhar number before submit
      const aadharField = form.querySelector('[name="aadhar_no"]');
      const aadharValue = aadharField ? aadharField.value.trim() : "";
      const aadharRegex = /^\d{12}$/;

      if (aadharField) aadharField.classList.remove("is-invalid");

      if (aadharValue && !aadharRegex.test(aadharValue)) {
        aadharField.classList.add("is-invalid");
        Swal.fire({
          icon: "error",
          title: "Invalid Aadhar Number",
          text: "Aadhar number must be exactly 12 digits.",
          confirmButtonColor: "#d33"
        });
        return;
      }

      // Fetch POST to current URL
      const response = await fetch("", {
        method: "POST",
        body: formData
      });

      let data;
      try {
        data = await response.json();
      } catch(err) {
        Swal.fire({
          icon: "error",
          title: "Server Error",
          text: "Unexpected response from server. Please try again.",
        });
        return;
      }

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Registration Successful ðŸŽ‰",
          text: "Your registration has been submitted successfully.",
          confirmButtonColor: "#0d6efd"
        });
        form.reset();
      } else {
        let errorText = "";
        for (const [field, errors] of Object.entries(data.errors || {})) {
          errorText += `${field}: ${errors.join(", ")}\n`;
        }
        Swal.fire({
          icon: "error",
          title: "Validation Error",
          text: errorText || "Please check your input and try again.",
        });
      }
    });
  </script>
</body>
</html>
